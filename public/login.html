<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>登录 / 注册</title>
      <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; background:#f5f6f7; margin:0; }
      .card { max-width: 420px; margin: 12vh auto; background:#fff; border-radius: 12px; padding: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
      h1 { font-size: 20px; margin: 0 0 8px; }
      p { color:#666; margin: 0 0 16px; }
      .btn { display:block; width:100%; padding: 12px 16px; margin: 10px 0; border:none; border-radius: 8px; color:#fff; font-weight:600; cursor:pointer; }
      .note { font-size: 12px; color:#888; margin-top: 12px; line-height: 1.5; }
      .divider { text-align:center; color:#aaa; font-size:12px; margin: 16px 0; position: relative; }
      .divider:before, .divider:after { content:""; position:absolute; top:50%; width:40%; height:1px; background:#eee; }
      .divider:before { left:0; } .divider:after { right:0; }
      input { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; margin-top:6px; }
      label { display:block; font-size:12px; color:#555; margin-top:10px; }
        .hidden-honeypot { position: absolute; left: -9999px; top: -9999px; height: 0; width: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>登录 / 注册</h1>
      <p>登录后提交申请，联系管理员审批通过后即可享用点读。</p>

      <div id="auth-block">
        <button class="btn" style="background:#4a90e2; margin-top:12px;" onclick="login()">使用邮箱登录</button>
        <div id="auth-info" style="display:none; font-size:12px; color:#666; margin-top:8px;"></div>
      </div>

      <div id="post-login" style="display:none;">
        <div id="local-form-block">
        <div class="divider">或</div>
        <form onsubmit="requestAccess(event)">
          <label>邮箱
            <input id="email" type="email" required placeholder="you@example.com" />
          </label>
          <label>备注（可选）
            <input id="note" type="text" placeholder="孩子姓名、年级等" />
          </label>
          <div class="hidden-honeypot">
            <label>请勿填写
              <input id="hp_access" type="text" autocomplete="off" />
            </label>
          </div>
          <button class="btn" style="background:#4a90e2; margin-top:12px;">提交注册申请</button>
        </form>
        </div>

        <div id="embed-container" style="display:none; margin-top:12px;">
        <div class="divider">或</div>
        <iframe id="embed-frame" src="" style="width:100%; height:520px; border:none; border-radius:8px; background:#fff;"></iframe>
        </div>
      </div>

      <div class="note">
        审批流程：您提交申请 → 管理员给您所有权限 → 重新登录后可访问。
      </div>
    </div>

    <script>
      let externalFormEndpoint = '';
      let embedUrl = '';
      let isLoggedIn = false;
      let loginProvider = 'aad';
      let userEmail = '';
      let userRoles = [];
      let lastSubmitAt = 0; // 节流：两次提交至少间隔 10 秒
      const DAILY_LIMIT = 5; // 本地防护：同一浏览器每天最多提交 5 次
      const MIN_FORM_TIME_MS = 3000; // 最短停留时间：3 秒
      let authFormShownAt = Date.now();

      async function loadAuth() {
        try {
          const res = await fetch('/.auth/me', { credentials: 'include' });
          if (!res.ok) {
            isLoggedIn = false; userEmail = ''; userRoles = [];
            return;
          }
          const data = await res.json();
          const p = (data && data.clientPrincipal) || null;
          if (p) {
            isLoggedIn = true;
            userEmail = p.userDetails || '';
            userRoles = p.userRoles || [];
          } else {
            isLoggedIn = false; userEmail = ''; userRoles = [];
          }
        } catch {
          isLoggedIn = false; userEmail = ''; userRoles = [];
        }
      }

      async function renderUI() {
        await loadAuth();
        const authBlock = document.getElementById('auth-block');
        const postLogin = document.getElementById('post-login');
        // 登录状态提示与跳转
        const info = document.getElementById('auth-info');
        if (isLoggedIn) {
          const hasApproved = Array.isArray(userRoles) && userRoles.includes('approved');
          info.style.display = 'block';
          info.textContent = hasApproved ? `已登录：${userEmail}（已获批，即将进入）` : `已登录：${userEmail}（未获批，提交申请后等待管理员审批）`;
          if (hasApproved) {
            setTimeout(() => { window.location.href = '/#/'; }, 800);
          }
        } else {
          info.style.display = 'none';
        }

        // 登录按钮始终可见
        authBlock.style.display = 'block';
        // 申请表单始终展示（嵌入或本地）
        postLogin.style.display = 'block';
        if (embedUrl) {
          document.getElementById('local-form-block').style.display = 'none';
          document.getElementById('embed-container').style.display = 'block';
          const frame = document.getElementById('embed-frame');
          if (frame && !frame.src) frame.src = embedUrl;
        } else {
          document.getElementById('local-form-block').style.display = 'block';
          document.getElementById('embed-container').style.display = 'none';
        }
      }

      function login() {
        window.location.href = `/.auth/login/${loginProvider}`;
      }

      fetch('/form-config.json')
        .then(r => r.ok ? r.json() : { formEndpoint: '', embedUrl: '' })
        .then(cfg => {
          externalFormEndpoint = (cfg && cfg.formEndpoint) || '';
          embedUrl = (cfg && cfg.embedUrl) || '';
          loginProvider = (cfg && cfg.loginProvider) || 'aad';
          renderUI();
        })
        .catch(() => { renderUI(); });

      async function requestAccess(e) {
        e.preventDefault();
        // 允许未登录也可提交申请
        const hp = (document.getElementById('hp_access') || {}).value || '';
        if (hp) { // 蜜罐触发
          alert('提交异常');
          return;
        }
        const now = Date.now();
        if (now - lastSubmitAt < 10000) { // 10 秒节流
          alert('操作过于频繁，请稍后重试');
          return;
        }
        lastSubmitAt = now;

        // 本地每日上限（按浏览器本地存储计数）
        const todayKey = 'access_submit_' + new Date().toISOString().slice(0,10);
        const used = parseInt(localStorage.getItem(todayKey) || '0', 10);
        if (used >= DAILY_LIMIT) {
          alert('今日提交次数已达上限，请明天再试');
          return;
        }

        const email = (document.getElementById('email') || {}).value;
        const note = (document.getElementById('note') || {}).value;
        try {
          // 优先使用外部表单服务
          let resp;
          if (externalFormEndpoint) {
            // Formspree 等传统表单接口通常接收 application/x-www-form-urlencoded 或 JSON
            // 这里用标准表单编码，兼容性更强
            const form = new FormData();
            form.append('email', email);
            form.append('note', note);
            form.append('_subject', '点读书访问申请');
            form.append('source', 'login.html');
            resp = await fetch(externalFormEndpoint, { method: 'POST', body: form });
          } else {
            // 将申请发送至自建 API（如 Azure Functions）
            resp = await fetch('/api/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, note, ts: Date.now() })
            });
          }
          if (resp.ok) {
            localStorage.setItem(todayKey, String(used + 1));
            alert('已提交申请，请等待管理员审批。');
          } else {
            alert('提交失败，请稍后重试或直接联系管理员。');
          }
        } catch (err) {
          alert('网络错误，请稍后重试。');
        }
      }

      // 记录表单渲染时间
      window.addEventListener('load', () => { authFormShownAt = Date.now(); });
    </script>
  </body>
  </html>


